<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>TMDB ‚Üí Blogger Post Generator</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { background:#f5f7fa; font-family:'Poppins',sans-serif; }
    .card { border-radius:20px; box-shadow:0 4px 14px rgba(0,0,0,0.1); }
    .output-box { background:#1e1e1e; color:#0f0; padding:15px; border-radius:10px; height:300px; overflow:auto; }
    .preview-box { background:#fff; padding:20px; border-radius:15px; box-shadow:0 2px 10px rgba(0,0,0,0.1); margin-top:15px; }
    .download-pair { display:flex; gap:10px; margin-bottom:10px; }
    button { border-radius:10px !important; }
  </style>
</head>
<body class="p-4">
  <div class="container">
    <h2 class="text-center mb-4">üé¨ TMDB ‚Üí Blogger Post Generator</h2>

    <div class="card p-4">
      <div class="mb-3">
        <label class="form-label">TMDB ID / Title</label>
        <input type="text" id="tmdbInput" class="form-control" placeholder="e.g. 550 or Breaking Bad" />
      </div>
      <button class="btn btn-primary mb-4" onclick="fetchTMDB()">Fetch from TMDB</button>

      <div id="fields">
        <div class="row">
          <div class="col-md-6">
            <label class="form-label">Type</label>
            <input id="type" class="form-control" placeholder="movie or series" />
          </div>
          <div class="col-md-6">
            <label class="form-label">Title</label>
            <input id="title" class="form-control" />
          </div>
        </div>
        <div class="row mt-3">
          <div class="col-md-6">
            <label class="form-label">Original Title</label>
            <input id="original_title" class="form-control" />
          </div>
          <div class="col-md-6">
            <label class="form-label">Tagline</label>
            <input id="tagline" class="form-control" />
          </div>
        </div>

        <label class="form-label mt-3">Overview</label>
        <textarea id="overview" class="form-control" rows="3"></textarea>

        <div class="row mt-3">
          <div class="col-md-6">
            <label class="form-label">Release / Air Date</label>
            <input id="release_date" class="form-control" />
          </div>
          <div class="col-md-6">
            <label class="form-label">Runtime</label>
            <input id="runtime" class="form-control" />
          </div>
        </div>

        <div class="row mt-3">
          <div class="col-md-6">
            <label class="form-label">Language(s)</label>
            <input id="languages" class="form-control" />
          </div>
          <div class="col-md-6">
            <label class="form-label">Genres</label>
            <input id="genres" class="form-control" />
          </div>
        </div>

        <div class="row mt-3">
          <div class="col-md-6">
            <label class="form-label">Rating</label>
            <input id="rating" class="form-control" />
          </div>
          <div class="col-md-6">
            <label class="form-label">Director / Writer</label>
            <input id="crew" class="form-control" />
          </div>
        </div>

        <label class="form-label mt-3">Cast</label>
        <input id="cast" class="form-control" />

        <label class="form-label mt-3">Poster URL</label>
        <input id="poster" class="form-control" />

        <label class="form-label mt-3">Backdrop URL</label>
        <input id="backdrop" class="form-control" />

        <label class="form-label mt-3">Trailer URL</label>
        <input id="trailer" class="form-control" />
      </div>

      <h5 class="mt-4">Download Links</h5>
      <div id="download-links"></div>
      <button class="btn btn-secondary mt-2" onclick="addDownload()">+ Add Link</button>

      <button class="btn btn-success w-100 mt-4" onclick="generateHTML()">Generate HTML</button>
    </div>

    <h4 class="mt-4">Generated HTML Code</h4>
    <div class="output-box" id="output"></div>

    <h4 class="mt-4">Preview (Blogger Style)</h4>
    <div id="preview" class="preview-box"></div>

    <div class="mt-3 d-flex gap-2">
      <button class="btn btn-outline-primary flex-fill" onclick="copyHTML()">Copy</button>
      <button class="btn btn-warning flex-fill" onclick="postToBlogger()">Post to Blogger</button>
    </div>
  </div>

<script>
const apiKey = "55b11132b5aef36e8376418dcce756f2";

async function fetchTMDB() {
  const input = document.getElementById("tmdbInput").value.trim();
  if (!input) return alert("Enter TMDB ID or name");

  let data, type = "movie";
  try {
    if (isNaN(input)) {
      const searchM = await fetch(`https://api.themoviedb.org/3/search/movie?api_key=${apiKey}&query=${encodeURIComponent(input)}`).then(r=>r.json());
      const searchT = await fetch(`https://api.themoviedb.org/3/search/tv?api_key=${apiKey}&query=${encodeURIComponent(input)}`).then(r=>r.json());
      if (searchM.results?.length) {
        data = await fetch(`https://api.themoviedb.org/3/movie/${searchM.results[0].id}?api_key=${apiKey}&append_to_response=credits,videos`).then(r=>r.json());
        type = "movie";
      } else if (searchT.results?.length) {
        data = await fetch(`https://api.themoviedb.org/3/tv/${searchT.results[0].id}?api_key=${apiKey}&append_to_response=credits,videos`).then(r=>r.json());
        type = "series";
      }
    } else {
      const movie = await fetch(`https://api.themoviedb.org/3/movie/${input}?api_key=${apiKey}&append_to_response=credits,videos`);
      if (movie.ok) {
        data = await movie.json(); type="movie";
      } else {
        const tv = await fetch(`https://api.themoviedb.org/3/tv/${input}?api_key=${apiKey}&append_to_response=credits,videos`);
        if (tv.ok) { data = await tv.json(); type="series"; }
      }
    }

    if (!data) return alert("Not found!");

    document.getElementById("type").value = type;
    document.getElementById("title").value = data.title || data.name || "";
    document.getElementById("original_title").value = data.original_title || data.original_name || "";
    document.getElementById("overview").value = data.overview || "";
    document.getElementById("tagline").value = data.tagline || "";
    document.getElementById("release_date").value = data.release_date || data.first_air_date || "";
    document.getElementById("runtime").value = data.runtime || (data.episode_run_time ? data.episode_run_time[0] : "");
    document.getElementById("languages").value = data.spoken_languages?.map(l=>l.english_name).join(", ");
    document.getElementById("genres").value = data.genres?.map(g=>g.name).join(", ");
    document.getElementById("rating").value = data.vote_average || "";
    document.getElementById("cast").value = data.credits?.cast?.slice(0,5).map(c=>c.name).join(", ");
    const crew = data.credits?.crew?.filter(c=>["Director","Writer","Screenplay"].includes(c.job)).map(c=>c.name).join(", ");
    document.getElementById("crew").value = crew || "";
    document.getElementById("poster").value = data.poster_path ? `https://image.tmdb.org/t/p/w500${data.poster_path}` : "";
    document.getElementById("backdrop").value = data.backdrop_path ? `https://image.tmdb.org/t/p/original${data.backdrop_path}` : "";
    const tr = data.videos?.results?.find(v=>v.type==="Trailer");
    document.getElementById("trailer").value = tr ? `https://www.youtube.com/watch?v=${tr.key}` : "";
  } catch (e) { console.error(e); alert("TMDB fetch error"); }
}

function addDownload() {
  const div = document.createElement("div");
  div.className = "download-pair";
  div.innerHTML = `<input class="form-control" placeholder="Label"><input class="form-control" placeholder="Download URL">`;
  document.getElementById("download-links").appendChild(div);
}

function generateHTML() {
  const g = id => document.getElementById(id).value;
  let dls = "";
  document.querySelectorAll("#download-links .download-pair").forEach(p=>{
    const l=p.children[0].value, u=p.children[1].value;
    if (l && u) dls += `<a class="btn btn-primary m-1" href="${u}" target="_blank">${l}</a>\n`;
  });
  const html = `
<div class="post">
  <img src="${g("backdrop")}" style="width:100%;border-radius:15px;">
  <h2 style="color:#ffcc00;">${g("title")} <small>(${g("type")})</small></h2>
  <p><b>Tagline:</b> ${g("tagline")}</p>
  <p><b>Overview:</b> ${g("overview")}</p>
  <img src="${g("poster")}" style="width:200px;border-radius:10px;">
  <p><b>Genres:</b> ${g("genres")}</p>
  <p><b>Release:</b> ${g("release_date")} | <b>Runtime:</b> ${g("runtime")}</p>
  <p><b>Language:</b> ${g("languages")}</p>
  <p><b>Rating:</b> ‚≠ê ${g("rating")}</p>
  <p><b>Crew:</b> ${g("crew")}</p>
  <p><b>Cast:</b> ${g("cast")}</p>
  ${g("trailer") ? `<iframe width="560" height="315" src="${g("trailer").replace("watch?v=","embed/")}" frameborder="0" allowfullscreen></iframe>` : ""}
  <div class="downloads mt-3">${dls}</div>
  <p><b>Labels:</b> ${g("genres")}</p>
</div>`;
  document.getElementById("output").innerText = html;
  document.getElementById("preview").innerHTML = html;
}

function copyHTML() {
  navigator.clipboard.writeText(document.getElementById("output").innerText);
  alert("Copied!");
}

async function postToBlogger() {
  const title = document.getElementById("title").value;
  const genres = document.getElementById("genres").value;
  const html = document.getElementById("output").innerText;
  if (!title || !html) return alert("Generate post first!");

  const res = await fetch("/api/publish", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ title, html, labels: genres })
  });
  const data = await res.json();
  alert(data.message || "Error sending post");
}
</script>
</body>
</html>